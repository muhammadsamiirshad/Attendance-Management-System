@model TimetableViewModel
@{
    ViewData["Title"] = Model?.Title ?? "Timetables";
}

<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h3 class="card-title mb-0">@ViewData["Title"]</h3>
                    @if (User.IsInRole("Admin"))
                    {
                        <a href="@Url.Action("Create", "Timetable")" class="btn btn-primary">
                            <i class="fas fa-plus"></i> Add New Timetable Entry
                        </a>
                    }
                </div>
                <div class="card-body">
                    @if (TempData["Success"] != null)
                    {
                        <div class="alert alert-success alert-dismissible fade show" role="alert">
                            @TempData["Success"]
                            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                        </div>
                    }

                    @if (Model?.Timetables != null && Model.Timetables.Any())
                    {
                        <!-- Weekly Timetable View -->
                        <div class="table-responsive">
                            <table class="table table-bordered table-hover">
                                <thead class="table-dark">
                                    <tr>
                                        <th>Time</th>
                                        <th>Monday</th>
                                        <th>Tuesday</th>
                                        <th>Wednesday</th>
                                        <th>Thursday</th>
                                        <th>Friday</th>
                                        <th>Saturday</th>
                                        <th>Sunday</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @{
                                        var timeSlots = Model.Timetables
                                            .Select(t => new { Start = t.StartTime, End = t.EndTime })
                                            .Distinct()
                                            .OrderBy(t => t.Start)
                                            .ToList();

                                        var daysOfWeek = new[] { 
                                            DayOfWeekEnum.Monday, 
                                            DayOfWeekEnum.Tuesday, 
                                            DayOfWeekEnum.Wednesday, 
                                            DayOfWeekEnum.Thursday, 
                                            DayOfWeekEnum.Friday, 
                                            DayOfWeekEnum.Saturday, 
                                            DayOfWeekEnum.Sunday 
                                        };
                                    }

                                    @foreach (var timeSlot in timeSlots)
                                    {
                                        <tr>
                                            <td class="fw-bold bg-light">
                                                @string.Format("{0:hh\\:mm}", timeSlot.Start) - @string.Format("{0:hh\\:mm}", timeSlot.End)
                                            </td>
                                            @foreach (var day in daysOfWeek)
                                            {
                                                var entry = Model.Timetables.FirstOrDefault(t => 
                                                    t.Day == day && 
                                                    t.StartTime == timeSlot.Start && 
                                                    t.EndTime == timeSlot.End);
                                                
                                                <td>
                                                    @if (entry != null)
                                                    {
                                                        <div class="timetable-entry p-2 bg-primary text-white rounded">
                                                            <div class="fw-bold">@entry.Course?.CourseName</div>
                                                            <small>@entry.Course?.CourseCode</small><br>
                                                            <small>@entry.Teacher?.AppUser?.FullName</small><br>
                                                            <small>Section: @entry.Section?.SectionName</small><br>
                                                            <small>Room: @entry.Classroom</small>
                                                            @if (User.IsInRole("Admin"))
                                                            {
                                                                <div class="mt-1">
                                                                    <a href="@Url.Action("Edit", "Timetable", new { id = entry.Id })" 
                                                                       class="btn btn-sm btn-outline-light me-1">
                                                                        <i class="fas fa-edit"></i>
                                                                    </a>
                                                                    <a href="@Url.Action("Delete", "Timetable", new { id = entry.Id })" 
                                                                       class="btn btn-sm btn-outline-danger"
                                                                       onclick="return confirm('Are you sure you want to delete this timetable entry?')">
                                                                        <i class="fas fa-trash"></i>
                                                                    </a>
                                                                </div>
                                                            }
                                                        </div>
                                                    }
                                                </td>
                                            }
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>

                        <!-- List View (Alternative) -->
                        <div class="mt-4">
                            <h5>Detailed List View</h5>
                            <div class="table-responsive">
                                <table class="table table-striped">
                                    <thead>
                                        <tr>
                                            <th>Course</th>
                                            <th>Teacher</th>
                                            <th>Section</th>
                                            <th>Day</th>
                                            <th>Time</th>
                                            <th>Classroom</th>
                                            @if (User.IsInRole("Admin"))
                                            {
                                                <th>Actions</th>
                                            }
                                        </tr>
                                    </thead>
                                    <tbody>
                                        @foreach (var timetable in Model.Timetables.OrderBy(t => t.Day).ThenBy(t => t.StartTime))
                                        {
                                            <tr>
                                                <td>
                                                    <strong>@timetable.Course?.CourseName</strong><br>
                                                    <small class="text-muted">@timetable.Course?.CourseCode</small>
                                                </td>
                                                <td>@timetable.Teacher?.AppUser?.FullName</td>
                                                <td>@timetable.Section?.SectionName</td>
                                                <td>@timetable.Day</td>
                                                <td>@string.Format("{0:hh\\:mm}", timetable.StartTime) - @string.Format("{0:hh\\:mm}", timetable.EndTime)</td>
                                                <td>@timetable.Classroom</td>
                                                @if (User.IsInRole("Admin"))
                                                {
                                                    <td>
                                                        <a href="@Url.Action("Edit", "Timetable", new { id = timetable.Id })" 
                                                           class="btn btn-sm btn-outline-primary me-1">
                                                            <i class="fas fa-edit"></i> Edit
                                                        </a>
                                                        <a href="@Url.Action("Delete", "Timetable", new { id = timetable.Id })" 
                                                           class="btn btn-sm btn-outline-danger"
                                                           onclick="return confirm('Are you sure you want to delete this timetable entry?')">
                                                            <i class="fas fa-trash"></i> Delete
                                                        </a>
                                                    </td>
                                                }
                                            </tr>
                                        }
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    }
                    else
                    {
                        <div class="alert alert-info">
                            <h5>No Timetable Entries Found</h5>
                            <p>There are currently no timetable entries in the system.</p>
                            @if (User.IsInRole("Admin"))
                            {
                                <a href="@Url.Action("Create", "Timetable")" class="btn btn-primary">
                                    Create First Timetable Entry
                                </a>
                            }
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    .timetable-entry {
        min-height: 80px;
        font-size: 0.85em;
    }
    
    .table td {
        vertical-align: middle;
        min-width: 120px;
    }
    
    .table th {
        text-align: center;
        vertical-align: middle;
    }
    
    .table-responsive {
        max-height: 600px;
        overflow-y: auto;
    }
</style>
