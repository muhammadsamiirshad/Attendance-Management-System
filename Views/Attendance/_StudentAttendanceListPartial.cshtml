@model AttendanceMarkViewModel

@if (Model != null && Model.Students != null && Model.Students.Any())
{
    <div class="card border-primary shadow">
        <div class="card-header bg-primary text-white">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h5 class="mb-0">
                        <i class="fas fa-users"></i> Mark Attendance for @Model.Course?.CourseName 
                    </h5>
                    <small>@Model.Date.ToString("dddd, MMMM dd, yyyy")</small>
                </div>
                <div>
                    <span class="badge bg-light text-dark">
                        <i class="fas fa-user-friends"></i> @Model.Students.Count Students
                    </span>
                </div>
            </div>
        </div>
        
        @* Attendance Window Status Alert *@
        @if (Model.WindowStatus != null)
        {
            @if (Model.WindowStatus.IsAllowed)
            {
                <div class="alert alert-success mb-0 rounded-0 border-0" role="alert">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <i class="fas fa-check-circle"></i>
                            <strong>Attendance Window Open</strong>
                            @if (Model.WindowStatus.WindowEndTime.HasValue)
                            {
                                <span class="ms-2">
                                    | <i class="fas fa-clock"></i> Available until 
                                    <strong>@Model.WindowStatus.WindowEndTime.Value.ToString("hh:mm tt")</strong>
                                </span>
                            }
                        </div>
                        <div>
                            <span class="badge bg-success" id="timeRemaining">
                                <i class="fas fa-hourglass-half"></i> Calculating...
                            </span>
                        </div>
                    </div>
                </div>
            }
            else if (Model.WindowStatus.IsLocked)
            {
                <div class="alert alert-danger mb-0 rounded-0 border-0" role="alert">
                    <i class="fas fa-lock"></i>
                    <strong>Attendance Locked</strong>
                    <span class="ms-2">@Model.WindowStatus.Message</span>
                </div>
            }
            else
            {
                <div class="alert alert-warning mb-0 rounded-0 border-0" role="alert">
                    <i class="fas fa-clock"></i>
                    <strong>Window Not Open Yet</strong>
                    <span class="ms-2">@Model.WindowStatus.Message</span>
                </div>
            }
        }
        
        <div class="card-body">
            <form id="attendanceForm">
                <input type="hidden" name="CourseId" value="@Model.CourseId" />
                <input type="hidden" name="Date" value="@Model.Date.ToString("yyyy-MM-dd")" />
                @Html.AntiForgeryToken()

                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead class="table-light">
                            <tr>
                                <th>Student</th>
                                <th>Student Number</th>
                                <th class="text-center">Present</th>
                                <th class="text-center">Absent</th>
                                <th>Remarks</th>
                            </tr>
                        </thead>
                        <tbody>
                            @for (int i = 0; i < Model.Students.Count; i++)
                            {
                                var student = Model.Students[i];
                                var studentName = !string.IsNullOrWhiteSpace(student.Student?.FirstName) || !string.IsNullOrWhiteSpace(student.Student?.LastName)
                                    ? $"{student.Student?.FirstName ?? ""} {student.Student?.LastName ?? ""}".Trim()
                                    : $"Student #{student.StudentId}";
                                var studentNumber = student.Student?.StudentNumber ?? "N/A";
                                <tr>
                                    <td>
                                        <strong>@studentName</strong>
                                        <input type="hidden" name="Students[@i].StudentId" value="@student.StudentId" />
                                    </td>
                                    <td>@studentNumber</td>
                                    <td class="text-center">
                                        <div class="form-check">
                                            <input class="form-check-input attendance-radio" 
                                                   type="radio" 
                                                   name="Students[@i].IsPresent" 
                                                   id="present_@i" 
                                                   value="true"
                                                   checked="@student.IsPresent">
                                            <label class="form-check-label text-success" for="present_@i">
                                                <i class="fas fa-check"></i>
                                            </label>
                                        </div>
                                    </td>
                                    <td class="text-center">
                                        <div class="form-check">
                                            <input class="form-check-input attendance-radio" 
                                                   type="radio" 
                                                   name="Students[@i].IsPresent" 
                                                   id="absent_@i" 
                                                   value="false"
                                                   checked="@(!student.IsPresent)">
                                            <label class="form-check-label text-danger" for="absent_@i">
                                                <i class="fas fa-times"></i>
                                            </label>
                                        </div>
                                    </td>
                                    <td>
                                        <input type="text" 
                                               name="Students[@i].Remarks" 
                                               value="@student.Remarks"
                                               class="form-control form-control-sm" 
                                               placeholder="Optional remarks">
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>

                <!-- Attendance Statistics Bar -->
                <div class="row mt-3 mb-3">
                    <div class="col-md-4">
                        <div class="card bg-light">
                            <div class="card-body py-2 text-center">
                                <h6 class="mb-0">
                                    <i class="fas fa-check-circle text-success"></i> 
                                    Present: <span id="presentCount" class="badge bg-success">0</span>
                                </h6>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card bg-light">
                            <div class="card-body py-2 text-center">
                                <h6 class="mb-0">
                                    <i class="fas fa-times-circle text-danger"></i> 
                                    Absent: <span id="absentCount" class="badge bg-danger">0</span>
                                </h6>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card bg-light">
                            <div class="card-body py-2 text-center">
                                <h6 class="mb-0">
                                    <i class="fas fa-percentage text-info"></i> 
                                    Attendance: <span id="attendancePercentage" class="badge bg-info">0%</span>
                                </h6>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="d-flex justify-content-between align-items-center mt-4">
                    <div>
                        <button type="button" class="btn btn-success me-2" onclick="markAllPresent()">
                            <i class="fas fa-check-double"></i> Mark All Present
                        </button>
                        <button type="button" class="btn btn-danger me-2" onclick="markAllAbsent()">
                            <i class="fas fa-times-circle"></i> Mark All Absent
                        </button>
                        <button type="button" class="btn btn-secondary" onclick="resetAttendance()">
                            <i class="fas fa-undo"></i> Reset
                        </button>
                    </div>
                    <button type="submit" class="btn btn-primary btn-lg shadow">
                        <i class="fas fa-save"></i> Save Attendance
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Countdown Timer
        @if (Model.WindowStatus != null && Model.WindowStatus.IsAllowed && Model.WindowStatus.WindowEndTime.HasValue)
        {
            @:const windowEndTime = new Date('@Model.WindowStatus.WindowEndTime.Value.ToString("o")');
            @:
            @:function updateCountdown() {
            @:    const now = new Date();
            @:    const timeLeft = windowEndTime - now;
            @:    
            @:    const timeRemainingElem = document.getElementById('timeRemaining');
            @:    if (!timeRemainingElem) return;
            @:    
            @:    if (timeLeft <= 0) {
            @:        timeRemainingElem.innerHTML = '<i class="fas fa-lock"></i> Window Closed';
            @:        timeRemainingElem.classList.remove('bg-success', 'bg-warning');
            @:        timeRemainingElem.classList.add('bg-danger');
            @:        return;
            @:    }
            @:    
            @:    const minutes = Math.floor(timeLeft / 60000);
            @:    const seconds = Math.floor((timeLeft % 60000) / 1000);
            @:    
            @:    let color = 'bg-success';
            @:    if (minutes < 5) color = 'bg-warning';
            @:    if (minutes < 2) color = 'bg-danger';
            @:    
            @:    timeRemainingElem.className = 'badge ' + color;
            @:    timeRemainingElem.innerHTML = '<i class="fas fa-hourglass-half"></i> ' + minutes + 'm ' + seconds + 's remaining';
            @:}
            @:
            @:updateCountdown();
            @:setInterval(updateCountdown, 1000);
        }
        else
        {
            @:const timeRemainingElem = document.getElementById('timeRemaining');
            @:if (timeRemainingElem) {
            @:    timeRemainingElem.style.display = 'none';
            @:}
        }
        
        // Update attendance statistics
        function updateStatistics() {
            const totalStudents = @Model.Students.Count;
            const presentRadios = document.querySelectorAll('input[type="radio"][value="true"]:checked');
            const presentCount = presentRadios.length;
            const absentCount = totalStudents - presentCount;
            const percentage = totalStudents > 0 ? Math.round((presentCount / totalStudents) * 100) : 0;
            
            document.getElementById('presentCount').textContent = presentCount;
            document.getElementById('absentCount').textContent = absentCount;
            document.getElementById('attendancePercentage').textContent = percentage + '%';
            
            // Update percentage badge color
            const percentageBadge = document.getElementById('attendancePercentage');
            percentageBadge.className = 'badge ' + 
                (percentage >= 75 ? 'bg-success' : percentage >= 50 ? 'bg-warning' : 'bg-danger');
        }

        function markAllPresent() {
            document.querySelectorAll('input[type="radio"][value="true"]').forEach(radio => {
                radio.checked = true;
                const row = radio.closest('tr');
                row.classList.remove('table-danger');
                row.classList.add('table-success');
            });
            updateStatistics();
        }

        function markAllAbsent() {
            document.querySelectorAll('input[type="radio"][value="false"]').forEach(radio => {
                radio.checked = true;
                const row = radio.closest('tr');
                row.classList.remove('table-success');
                row.classList.add('table-danger');
            });
            updateStatistics();
        }
        
        function resetAttendance() {
            // Reset all to present (default)
            markAllPresent();
            // Clear all remarks
            document.querySelectorAll('input[name*="Remarks"]').forEach(input => {
                input.value = '';
            });
        }

        // Add visual feedback for attendance selection
        document.querySelectorAll('.attendance-radio').forEach(radio => {
            radio.addEventListener('change', function() {
                const row = this.closest('tr');
                row.classList.remove('table-success', 'table-danger');
                
                if (this.value === 'true' && this.checked) {
                    row.classList.add('table-success');
                } else if (this.value === 'false' && this.checked) {
                    row.classList.add('table-danger');
                }
                
                updateStatistics();
            });
            
            // Set initial visual state
            if (radio.checked) {
                const row = radio.closest('tr');
                if (radio.value === 'true') {
                    row.classList.add('table-success');
                } else {
                    row.classList.add('table-danger');
                }
            }
        });
        
        // Initialize statistics on page load
        updateStatistics();
    </script>
}
else
{
    <div class="card border-warning shadow">
        <div class="card-header bg-warning text-dark">
            <h5 class="mb-0"><i class="fas fa-exclamation-triangle"></i> No Students Found</h5>
        </div>
        <div class="card-body">
            <div class="alert alert-warning border-0">
                <h6><strong>⚠️ No students are available for attendance marking</strong></h6>
                <p class="mb-2">This can happen for two reasons:</p>
                <ol class="mb-3">
                    <li><strong>Students are not enrolled</strong> in this course yet</li>
                    <li><strong>Student registrations are inactive</strong> (most common issue)</li>
                </ol>
            </div>
            
            <div class="card bg-light border-danger mb-3">
                <div class="card-body">
                    <h6 class="text-danger"><i class="fas fa-tools"></i> <strong>Quick Fix</strong></h6>
                    <p class="small mb-2">If students ARE enrolled but don't show up, this is likely a database issue where registrations are marked as inactive.</p>
                    
                    <div class="alert alert-info border-0 small mb-2">
                        <strong>For Admins:</strong>
                        <ol class="mb-0 ps-3">
                            <li>Go to: <strong>Admin</strong> → <strong>Assign Courses to Students</strong></li>
                            <li>Scroll to the red <strong>"Quick Fix"</strong> card</li>
                            <li>Click <strong>"Fix 'No Students Found' Issue"</strong> button</li>
                            <li>Come back and reload this page</li>
                        </ol>
                    </div>
                    
                    <div class="alert alert-secondary border-0 small mb-0">
                        <strong>For Developers:</strong>
                        <ul class="mb-0 ps-3">
                            <li>Check the database: <code>SELECT * FROM StudentCourseRegistrations WHERE CourseId = @Model.CourseId AND IsActive = 0</code></li>
                            <li>Run SQL fix: <code>UPDATE StudentCourseRegistrations SET IsActive = 1 WHERE IsActive = 0</code></li>
                            <li>Or execute the script: <code>FIX_ATTENDANCE_STUDENTS_NOW.sql</code></li>
                            <li>Check Visual Studio Output window for detailed debug logs</li>
                        </ul>
                    </div>
                </div>
            </div>
            
            <div class="alert alert-secondary border-0 mb-0">
                <h6><i class="fas fa-info-circle"></i> <strong>Need to enroll students?</strong></h6>
                <p class="small mb-2">If students truly aren't enrolled yet:</p>
                <ol class="small mb-0 ps-3">
                    <li>Go to: <strong>Admin</strong> → <strong>Assign Courses to Students</strong></li>
                    <li>Select the course: <strong>@(Model.Course?.CourseName ?? "selected course")</strong></li>
                    <li>Select students to enroll</li>
                    <li>Click <strong>"Assign Selected Students"</strong></li>
                </ol>
            </div>
        </div>
    </div>
}
